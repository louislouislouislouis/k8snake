# kiwioas

This project is an example demonstrating how to extend a CLI client generated by [oasnake](https://github.com/louislouislouislouis/oasnake) to meet specific project requirements.

The generated client is extended to perform three main tasks before executing an API request:

1. **Kubernetes Port-Forwarding:** It automatically establishes a port-forwarding session to a defined service within a Kubernetes cluster.
2. **Keycloak Authentication:** It obtains an access token via a client credentials flow from a Keycloak instance.
3. **Custom Header Injection:** It adds a custom header to each request.

All configurations (Kubernetes service, Keycloak instance, custom headers) are defined as constants in the `main.go` file.

## How it Works

The extension mechanism relies on the `Hooks` and `RequestModifiers` provided by `oasnake`.

1. **Client Generation:** The `go generate` command invokes `oasnake` to generate the API client code from an OpenAPI specification (`things-api.yaml`).
2. **Command Execution:** When a CLI command is run (e.g., `go run main.go things get`), a `PersistentPreRun` Hook is triggered.
3. **The Hook performs the following actions:**
    a. Connects to the Kubernetes cluster using the local `kubeconfig`.
    b. Finds the target service and its corresponding pods in the configured namespace.
    c. Establishes a port-forwarding session from a local port to the service port on one of the pods.
    d. Retrieves Keycloak client credentials (ID and secret) from a Kubernetes Secret.
    e. Uses these credentials to request an access token from the Keycloak instance.
4. **Request Modification:** Just before the request is sent, a `RequestModifier` intervenes to:
    a. Replace the request's host with the local port-forward address (`localhost:PORT`).
    b. Inject the access token into the `Authorization` header (`Bearer <token>`).
    c. Add a custom header, also defined in the `main.go` constants.
5. **Request Dispatch:** The modified request is then sent to the service running in Kubernetes through the port-forwarding tunnel.

## Prerequisites

- Go (version 1.24 or higher).
- `kubectl` configured with access to a Kubernetes cluster.
- A target service deployed in the cluster.
- An accessible Keycloak instance and a Kubernetes Secret containing the `CLIENT_ID` and `CLIENT_SECRET`.

## Installation and Configuration

1. **Install oasnake:**
    This project requires a specific version of `oasnake` that enables these extensions. Install it using the following command, which points to the exact commit:

    ```sh
    go install github.com/louislouislouislouis/oasnake@3b86bba423422fa29e7a7e0554e52a44aa68f322
    ```

2. **Configure the project:**
    Modify the configuration variables in the `main.go` file to match your environment.

    ```go
    // main.go

    var (
        /*
         * Kubernetes configuration
         */
        k8sNamespace = "mysuperservice"
        serviceName  = "mysupernamespace"
        servicePort  = 8080

        /*
         * Keycloak Configuration
         */
        clientSecretID = "mysuperclientid"
        realmName      = "myrealm"
        keycloakURL    = "https://myauth.com/auth/realms/myrealm/protocol/openid-connect/token"

        /*
         * Custom headers
         */
        customHeaderName  = "custom-agent"
        customHeaderValue = "go code"
    )
    ```

## Usage

1. **Generate the API client:**
    Generation is done via `go generate`.

    ```sh
    go generate ./...
    ```

2. **Run the application:**
    Once the client is generated and configured, you can run the application.

    ```sh
    go run main.go [command] [flags]
    ```

    The available commands are defined by your OpenAPI specification.

## Build

To create a standalone executable:

```sh
go build -o kiwioas
./kiwioas [command] [flags]
```
